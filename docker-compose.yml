version: '3'

services:
    monolith.nginx:
        build:
            context: ./env/monolith/nginx
            dockerfile: Dockerfile
        volumes:
            - ./services/monolith:/var/www/symfony/
        ports:
            - ${MONOLITH_HTTP_PORT:-10001}:80

    monolith.db:
        image: mysql:8.0.20
        command: --default-authentication-plugin=mysql_native_password
        volumes:
            - "monolith_db_volume:/var/lib/mysql"
        environment:
            MYSQL_ROOT_PASSWORD: ${MONOLITH_MYSQL_ROOT_PASSWORD:-hello}
            MYSQL_DATABASE: ${MONOLITH_MYSQL_DATABASE:-app_db}
            MYSQL_USER: ${MONOLITH_MYSQL_USER:-app_user}
            MYSQL_PASSWORD: ${MONOLITH_MYSQL_PASSWORD:-helloworld}
        ports:
            - ${MONOLITH_MYSQL_PORT:-10002}:3306

    monolith.php:
        build:
            context: ./env/monolith/php
            dockerfile: Dockerfile
            args:
                TIMEZONE: ${TIMEZONE:-America/New_York}
        volumes:
            - ./services/monolith:/var/www/symfony/

    webapp:
        build:
            context: ./env/webapp
            dockerfile: Dockerfile
        ports:
            - "${WEBAPP_VUE_CLI_UI_PORT:-11001}:8000"
            - "${WEBAPP_HTTP_PORT:-11002}:8080"
            - '3000:3000'
        volumes:
            - ./services/webapp:/var/webapp
        stdin_open: true
        tty: true
        environment:
            - CHOKIDAR_USEPOLLING=true
            - USE_VUE_UI=${WEBAPP_USE_VUE_UI:-0}
            - VUE_APP_MONOLITH_HTTP_PORT=${MONOLITH_HTTP_PORT:-10001}
        working_dir: /var/webapp

volumes:
    monolith_db_volume:
